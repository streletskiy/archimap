<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Админка | archimap</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Manrope", "Segoe UI", "Roboto", "Arial", "sans-serif"]
          },
          colors: {
            brand: {
              purple: "#5B62F0"
            }
          },
          boxShadow: {
            soft: "0 8px 24px rgba(15, 23, 42, 0.08)"
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (function applyInitialTheme() {
      const key = 'archimap-theme';
      let theme = 'light';
      try {
        const stored = localStorage.getItem(key);
        if (stored === 'light' || stored === 'dark') {
          theme = stored;
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          theme = 'dark';
        }
      } catch {
        theme = 'light';
      }
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-900">
  <div id="top-nav-root"></div>

  <div id="admin-loading" class="w-full px-4 pb-5 pt-[5.5rem] sm:pb-6 sm:pt-[6rem]">
    <div class="mx-auto max-w-2xl rounded-2xl border border-slate-200 bg-white/95 p-6 text-center shadow-soft backdrop-blur-sm">
      <p class="text-sm font-semibold text-slate-700">Проверка доступа...</p>
    </div>
  </div>

  <div id="admin-app" class="page-with-edit-pane hidden w-full px-3 pb-5 pt-[5.5rem] sm:px-4 sm:pb-6 sm:pt-[5.25rem]">
    <div class="w-full space-y-4">
      <section class="rounded-2xl border border-slate-200 bg-white/95 p-4 shadow-soft backdrop-blur-sm sm:p-5">
        <div class="flex flex-wrap items-start justify-between gap-3 border-b border-slate-200 pb-4">
          <div>
            <h1 class="text-2xl font-extrabold">Админ-панель</h1>
            <p id="admin-subtitle" class="mt-1 text-sm text-slate-600">Пользователи и локальные правки</p>
          </div>
        </div>

        <div class="mt-4">
          <ul class="ui-tab-shell flex flex-wrap gap-1" id="admin-tabs" role="tablist">
            <li role="presentation"><button id="tab-users" type="button" class="ui-tab-btn">Пользователи</button></li>
            <li role="presentation"><button id="tab-edits" type="button" class="ui-tab-btn">Все правки</button></li>
            <li role="presentation"><button id="tab-settings" type="button" class="ui-tab-btn">Настройки</button></li>
            <li role="presentation"><button id="tab-guide" type="button" class="ui-tab-btn">Регламент правок</button></li>
            <li role="presentation"><button id="tab-uikit" type="button" class="ui-tab-btn">UI kit</button></li>
          </ul>
        </div>

        <section id="users-panel" class="mt-4 space-y-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-4">
          <div class="grid gap-3 lg:grid-cols-[1.4fr_repeat(3,minmax(0,1fr))]">
            <label class="relative">
              <span class="sr-only">Поиск пользователей</span>
              <input id="users-search" type="search" placeholder="Поиск по имени и email" class="ui-field" />
            </label>
            <select id="users-role-filter" class="ui-field">
              <option value="">Роль: все</option>
              <option value="admin">Только администраторы</option>
              <option value="user">Только пользователи</option>
            </select>
            <select id="users-can-edit-filter" class="ui-field">
              <option value="">Права: все</option>
              <option value="true">Может редактировать</option>
              <option value="false">Без прав редактирования</option>
            </select>
            <div class="flex gap-2">
              <select id="users-sort-by" class="ui-field">
                <option value="createdAt">Сортировка: регистрация</option>
                <option value="editsCount">По количеству правок</option>
                <option value="email">По email</option>
                <option value="firstName">По имени</option>
                <option value="lastName">По фамилии</option>
              </select>
              <select id="users-sort-dir" class="ui-field">
                <option value="desc">↓</option>
                <option value="asc">↑</option>
              </select>
              <button id="users-refresh" type="button" class="ui-btn ui-btn-secondary">Обновить</button>
            </div>
          </div>
          <div class="mt-3 hidden">
            <select id="users-has-edits-filter">
              <option value="">Все</option>
            </select>
          </div>
        </div>

        <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
          <div class="border-b border-slate-200 px-4 py-3">
            <p id="users-status" class="text-sm text-slate-600">Загрузка...</p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-700">
              <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
                <tr>
                  <th class="px-4 py-3">Пользователь</th>
                  <th class="px-4 py-3">Регистрация</th>
                  <th class="px-4 py-3">Права</th>
                  <th class="px-4 py-3">Правки</th>
                  <th class="px-4 py-3 text-right">Действия</th>
                </tr>
              </thead>
              <tbody id="users-list">
                <tr class="border-t border-slate-200">
                  <td class="px-4 py-3">
                    <p class="font-semibold text-slate-900">Анна Петрова</p>
                    <p class="text-xs text-slate-500">anna@example.com</p>
                  </td>
                  <td class="px-4 py-3 text-slate-600">12.01.2026</td>
                  <td class="px-4 py-3">
                    <span class="mr-1 rounded-full bg-violet-100 px-2.5 py-1 text-xs font-medium text-violet-700">Админ</span>
                    <span class="rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-medium text-emerald-700">Может редактировать</span>
                  </td>
                  <td class="px-4 py-3"><button class="font-semibold text-brand-purple underline">18</button></td>
                  <td class="px-4 py-3 text-right"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        </section>

        <section id="edits-panel" class="hidden mt-4 space-y-4">
        <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
          <div id="admin-map" class="h-[340px] w-full"></div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-4">
          <div class="grid gap-3 lg:grid-cols-[1.4fr_repeat(4,minmax(0,1fr))]">
            <input id="edits-search" type="search" placeholder="Поиск по адресу или ID здания" class="ui-field" />
            <input id="edits-date-filter" type="date" class="ui-field" />
            <select id="edits-user-filter" class="ui-field">
              <option value="">Пользователь: все</option>
            </select>
            <select id="edits-status-filter" class="ui-field">
              <option value="pending">Статус: на рассмотрении</option>
              <option value="accepted">Статус: принято</option>
              <option value="partially_accepted">Статус: частично принято</option>
              <option value="rejected">Статус: отклонено</option>
              <option value="superseded">Статус: заменено новой правкой</option>
              <option value="all">Статус: все</option>
            </select>
            <p id="edits-status" class="flex items-center rounded-[16px] border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-600">Загрузка...</p>
          </div>
        </div>

        <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-700">
              <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
                <tr>
                  <th class="px-4 py-3">Здание</th>
                  <th class="px-4 py-3">Автор</th>
                  <th class="px-4 py-3">Статус</th>
                  <th class="px-4 py-3">Изменения тегов</th>
                </tr>
              </thead>
              <tbody id="edits-list">
                <tr class="border-t border-slate-200 hover:bg-slate-50">
                  <td class="px-4 py-3">
                    <p class="font-semibold text-slate-900">ул. Большая Покровская, 12</p>
                    <p class="text-xs text-slate-500">ID: way/22891444</p>
                  </td>
                  <td class="px-4 py-3">Иван Смирнов</td>
                  <td class="px-4 py-3"><span class="rounded-full bg-amber-100 px-2.5 py-1 text-xs font-semibold text-amber-700">На рассмотрении</span></td>
                  <td class="px-4 py-3">
                    <div class="flex flex-wrap items-center gap-2">
                      <span class="rounded-md bg-slate-100 px-2 py-1 text-xs text-slate-600">5 всего</span>
                      <span class="rounded-md bg-emerald-50 px-2 py-1 text-xs text-emerald-600">+2 создано</span>
                      <span class="rounded-md bg-blue-50 px-2 py-1 text-xs text-blue-600">~3 изменено</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        </section>

        <section id="settings-panel" class="hidden mt-4">
          <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <h2 class="text-lg font-extrabold text-slate-900">Настройки приложения: Общие</h2>
                <p class="mt-1 text-sm text-slate-600">Влияет на регистрацию, отображаемое название и ссылки в email.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="general-save-btn" type="button" class="ui-btn ui-btn-primary">Сохранить общие</button>
              </div>
            </div>
            <p id="general-settings-status" class="mt-3 text-sm text-slate-600"></p>

            <div class="mt-4 grid gap-3 lg:grid-cols-2">
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">Название приложения</span>
                <input id="general-app-display-name" type="text" placeholder="archimap" class="ui-field" />
              </label>
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">APP_BASE_URL</span>
                <input id="general-app-base-url" type="text" placeholder="https://archimap.example.com" class="ui-field" />
              </label>
            </div>
            <div class="mt-3 flex flex-wrap items-center gap-4">
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                <input id="general-registration-enabled" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-brand-purple focus:ring-brand-purple" />
                Разрешить регистрацию
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                <input id="general-user-edit-requires-permission" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-brand-purple focus:ring-brand-purple" />
                Правки зданий только при can_edit=1
              </label>
            </div>
          </div>

          <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <h2 class="text-lg font-extrabold text-slate-900">Настройки приложения: SMTP</h2>
                <p class="mt-1 text-sm text-slate-600">Доступно только master admin. Пароль хранится в зашифрованном виде.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="smtp-test-btn" type="button" class="ui-btn ui-btn-secondary">Проверить SMTP</button>
                <button id="smtp-save-btn" type="button" class="ui-btn ui-btn-primary">Сохранить</button>
              </div>
            </div>
            <p id="smtp-settings-status" class="mt-3 text-sm text-slate-600"></p>

            <div class="mt-4 grid gap-3 lg:grid-cols-2">
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">SMTP URL (опционально)</span>
                <input id="smtp-url" type="text" placeholder="smtp://user:pass@mail.example.com:587" class="ui-field" />
              </label>
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">From</span>
                <input id="smtp-from" type="text" placeholder="archimap <no-reply@example.com>" class="ui-field" />
              </label>
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">SMTP Host</span>
                <input id="smtp-host" type="text" placeholder="smtp.example.com" class="ui-field" />
              </label>
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">SMTP Port</span>
                <input id="smtp-port" type="number" min="1" max="65535" placeholder="587" class="ui-field" />
              </label>
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">SMTP User</span>
                <input id="smtp-user" type="text" placeholder="no-reply@example.com" class="ui-field" />
              </label>
              <label class="block">
                <span class="mb-1 block text-xs font-semibold text-slate-700">SMTP Password</span>
                <input id="smtp-pass" type="password" placeholder="Оставьте пустым, чтобы не менять" class="ui-field" />
              </label>
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-4">
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                <input id="smtp-secure" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-brand-purple focus:ring-brand-purple" />
                SMTPS / secure
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                <input id="smtp-keep-password" type="checkbox" checked class="h-4 w-4 rounded border-slate-300 text-brand-purple focus:ring-brand-purple" />
                Сохранить текущий пароль, если поле пустое
              </label>
            </div>
          </div>
        </section>

        <section id="guide-panel" class="hidden mt-4">
          <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <h2 id="admin-guide-title" class="text-lg font-extrabold text-slate-900">Регламент обработки правок</h2>
            <p id="admin-guide-subtitle" class="mt-1 text-sm text-slate-600">Как работает модерация, конфликтные ситуации и статусы.</p>
            <div id="admin-guide-content" class="mt-4 space-y-3 text-sm text-slate-700"></div>
          </div>
        </section>

        <section id="uikit-panel" class="hidden mt-4">
          <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
            <h2 id="admin-uikit-title" class="text-lg font-extrabold text-slate-900"></h2>
            <p id="admin-uikit-subtitle" class="mt-1 text-sm text-slate-600"></p>

            <div class="mt-4 grid gap-4 lg:grid-cols-2">
              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 id="admin-ui-badges-title" class="text-base font-bold"></h3>
                <div id="admin-ui-badges" class="mt-3 flex flex-wrap gap-2"></div>
                <p id="admin-ui-badges-api" class="mt-2 text-xs text-slate-500"></p>
              </section>

              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 id="admin-ui-toggles-title" class="text-base font-bold"></h3>
                <div id="admin-ui-toggles" class="mt-3 flex items-center gap-3"></div>
                <p id="admin-ui-toggles-api" class="mt-2 text-xs text-slate-500"></p>
              </section>

              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 id="admin-ui-panel-title" class="text-base font-bold"></h3>
                <div id="admin-ui-panel-demo" class="mt-3"></div>
                <p id="admin-ui-panel-api" class="mt-2 text-xs text-slate-500"></p>
              </section>

              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 id="admin-ui-header-title" class="text-base font-bold"></h3>
                <div id="admin-ui-header-demo" class="mt-3"></div>
                <p id="admin-ui-header-api" class="mt-2 text-xs text-slate-500"></p>
              </section>

              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 id="admin-ui-tabs-title" class="text-base font-bold"></h3>
                <div id="admin-ui-tabs-demo" class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-1"></div>
                <p id="admin-ui-tabs-api" class="mt-2 text-xs text-slate-500"></p>
              </section>

              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 id="admin-ui-fields-title" class="text-base font-bold"></h3>
                <div id="admin-ui-fields-buttons-demo" class="mt-3 space-y-3"></div>
                <p id="admin-ui-fields-api" class="mt-2 text-xs text-slate-500"></p>
              </section>

              <section class="rounded-2xl border border-slate-200 bg-slate-50 p-4 lg:col-span-2">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <h3 id="admin-ui-emails-title" class="text-base font-bold"></h3>
                  <button id="admin-ui-email-refresh" type="button" class="ui-btn ui-btn-secondary ui-btn-xs"></button>
                </div>
                <p id="admin-ui-email-status" class="mt-2 text-xs text-slate-500"></p>
                <div id="admin-ui-email-previews" class="mt-3 space-y-4"></div>
              </section>
            </div>

            <section class="ui-info-panel mt-4 rounded-2xl p-4">
              <h3 id="admin-ui-guide-title" class="ui-info-title text-base font-bold"></h3>
              <ol class="ui-info-text mt-2 list-decimal space-y-1 pl-5 text-sm">
                <li id="admin-ui-guide-item-1"></li>
                <li id="admin-ui-guide-item-2"></li>
                <li id="admin-ui-guide-item-3"></li>
                <li id="admin-ui-guide-item-4"></li>
              </ol>
            </section>
          </div>
        </section>
      </section>
    </div>
  </div>

  <div id="edit-detail-pane-root"></div>

  <script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@4.3.0/dist/pmtiles.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>
  <script src="/i18n/ru.js"></script>
  <script src="/shared/text-utils.js"></script>
  <script src="/shared/ui.js"></script>
  <script src="/shared/top-nav-templates.js"></script>
  <script src="/shared/top-nav.js"></script>
  <script src="/shared/panel-page.js"></script>
  <script src="/admin/users/users-module.js"></script>
  <script src="/admin/edits/edits-module.js"></script>
  <script src="/admin/map/map-module.js"></script>
  <script src="/admin/guide-uikit/guide-uikit-module.js"></script>
  <script>window.ArchiMapTopNav.render({ context: 'admin' });</script>
  <script>
    (function renderSharedEditPane() {
      var root = document.getElementById('edit-detail-pane-root');
      if (!root || !window.ArchiMapUI || typeof window.ArchiMapUI.editDetailPane !== 'function') return;
      root.innerHTML = window.ArchiMapUI.editDetailPane();
    })();
  </script>
  <script src="/app-config.js"></script>
  <script src="/styles/local-buildings-style.js"></script>
  <script src="/admin.js"></script>
</body>
</html>
